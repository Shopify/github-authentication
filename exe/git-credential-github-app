#!/usr/bin/env ruby
# frozen_string_literal: true

require "github_authentication"

begin
  require "active_support"
  require "active_support/cache"
  require "active_support/notifications"
rescue LoadError
  warn("Active Support is required for the credential helper")
  exit(2)
end

case ARGV[0]
when "get"
  description = $stdin.each_line.map { |line| line.split("=", 2).map(&:strip) }.to_h
  org = description.fetch("path", "").split("/").first
  environment = GithubAuthentication::Environment.new(org: org)

  exit_status = GithubAuthentication::GitCredentialHelper.new(
    pem: environment.pem,
    app_id: environment.app_id,
    installation_id: environment.installation_id,
    storage: environment.storage,
    description: description,
  ).handle_get
  exit(exit_status)
when "store"
  # We maintain our own internal storage, so no-op any `store` requests
when nil, ""
  warn("Supported operations: get, store")
  exit(1)
else
  warn("Unknown argument: #{ARGV[0]}")
  exit(1)
end
